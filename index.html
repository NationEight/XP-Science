<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Pomodoro Widget</title>

<style>

  /* 1ST FONT */
  @font-face {
    font-family: '1st font';
    src: url('https://raw.githubusercontent.com/NationEight/XP-Science/main/Normal%20Fonts/digital-7%20(mono).ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
  
  /* 2ND FONT (SYMBOL) */
  @font-face {
    font-family: '2nd font';
    src: url('https://raw.githubusercontent.com/NationEight/XP-Science/main/JP%20Fonts/MochiyPopOne-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
  
  /* 3RD FONT (+1) */
  @font-face {
    font-family: '3rd font';
    src: url('https://raw.githubusercontent.com/NationEight/XP-Science/main/Normal%20Fonts/Square.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }

  /* COULEURS */
  :root {
    --bg-main: #191919;        /* ← couleur background (sombre) */
    --primary: #14DCFF;        /* ← couleur primaire */
    --accent: #14DCFF;         /* ← couleur cagnotte et du symbol ON */
    --accent-glow1: #FFFFFF;   /* ← glow interne */
    --accent-glow2: #14DCFF;   /* ← glow externe */
    --text-light: #ffffff;     /* ← texte clair */
    --text-dark: #191919;      /* ← texte sombre */
    --logo-on: #14DCFF;        /* ← couleur symbol quand timer ON */
    --logo-off: transparent;   /* ← couleur symbol quand timer OFF */
    --gain-color: #14DCFF;     /* ← couleur du +1 */
  }

  /* LIGHT MODE */
  .light-mode {
    --bg-main: #ffffff;        /* ← couleur de fond en mode clair */
    --text-light: #ffffff;     /* ← couleur du symbol clair/sombre en mode clair */
    --logo-off: transparent;
  }

  /* BODY */
  body {
    margin: 0;
    background-color: var(--bg-main);
    font-family: '1st font', monospace;
    color: var(--text-light);
    font-size: 25px;
  }

  /* CONTAINER */
  .container {
    width: 100%;               /* ← rend la largeur adaptative à l'encadré */
    max-width: 2000px;         /* ← modifiable pour un maximum fixe */
    padding: 4px;              /* ← marge globale */
    display: flex;
    flex-direction: column;
    gap: 6px;                  /* ← espace entre les deux blocs (progress bar & timer) */
    box-sizing: border-box;
  }

  /* PROGRESS BAR EMPTY */
  .progress-bar {
    display: flex;
    align-items: center;
    background-color: #323232;                  /* ← couleur de la progress bar vide */
    box-shadow: 0 0 4px rgba(38, 38, 38, 0.0);  /* ← effet néon/ombre sur la progress bar vide */
    height: 28px;                               /* ← hauteur de la progress-bar */
    position: relative;
    overflow: hidden;
    width: 100%;                                /* ← prend toute la largeur du container */
    border-radius: 4px;                         /* ← coins arrondis sur la progress bar vide */
  }
  
  /* PROGRESS BAR FILL */
  .progress-fill {
    background-color: var(--primary);               /* ← couleur de la progress bar remplie */
    height: 100%;
    width: 0%;
    box-shadow: 0 0 10px rgba(20, 255, 251, 0.6);   /* ← effet néon de la progress bar remplie */
    transition: width 0.12s linear;                 /* ← animation fluide et réactive */
    border-radius: 4px;                             /* ← coins arrondis sur la progress bar remplie */
  }
  
  /* PROGRESS BAR TEXT */
  .progress-text {
    font-size: 21px;          /* ← taille de la police de la progress bar */
    position: absolute;
    left: 6px;                /* ← marge à gauche du texte de la progress bar */
    color: var(--text-dark);  /* ← couleur de la police de la progress bar */
    font-weight: 200;
  }
  
  .progress-text strong {
    font-weight: 700;         /* ← gras sur les chiffres du % de la progress bar */
  }

  /* BLOC TIMER */
  .timer-flame-block {
    position: relative;                         /* ← pour contenir le ::after */
    height: 57px;                               /* ← hauteur du bloc timer */
    background: radial-gradient(                /* ← dégradé */
      circle at center,
      rgba(49, 52, 50, 0.20),                   /* ← centre lumineux */
      rgba(30, 30, 30, 0.95)                    /* ← fondu sombre */
    ),
    #262626;                                    /* ← couleur de base en fallback */
    background-color: #262626;                  /* ← couleur du bloc timer */
    box-shadow: 0 0 4px rgba(38, 38, 38, 0.8);  /* ← effet néon/ombre sur le gros bloc timer */
    padding: 8px;                               /* ← marge du bloc timer (de tout ce qui est à l'intérieur) */
    display: flex;
    flex-direction: column;
    gap: 4px;                                   /* ← marge entre la première et deuxième ligne du bloc timer */
    overflow: hidden;                           /* ← coupe tout ce qui dépasse */
    border-radius: 4px;                         /* ← coins arrondis sur le bloc timer */
    border: 1px solid #2E2E2E;                  /* ← bordure du bloc timer à ajouter si besoin */
  }
  
  /* BLOC TIMER HORIZONTAL SCAN LINE */
  .timer-flame-block::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;             /* ← ne bloque pas le timer */
    background-image: repeating-linear-gradient(
      to bottom,
      rgba(255, 255, 255, 0.06),      /* ← lignes claires */
      rgba(255, 255, 255, 0.00) 1px,  /* ← lignes sombres */
      transparent 1px,                /* ← épaisseur des lignes clair */
      transparent 2px                 /* ← épaisseur des lignes sombres */
    );
    z-index: 2;                       /* ← au-dessus du fond mais derrière le texte si nécessaire */
    border-radius: 4px;               /* ← coins arrondis sur les lignes de balayages horizontales */
  }
  
  /* BLOC TIMER VERTICALE SCAN LINE */
  .timer-flame-block::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    background-image: repeating-linear-gradient(
     to right,
     rgba(255, 255, 255, 0.02),
     rgba(255, 255, 255, 0.00) 1px,
     transparent 1px,
     transparent 2px
   );
   z-index: 2;
   border-radius: 4px;                /* ← coins arrondis sur les lignes de balayages verticales */
  }

  /* BUTTONS */
  .controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .btn-group {
    display: flex;
    gap: 4px;                                 /* ← marge entre les deux boutons (PLAY & STOP) */
  }

  /* BOUTONS */
  .img-btn {
    width: 25px;                              /* ← changer ici la taille des boutons */
    height: 25px;                             /* ← changer ici la taille des boutons */
    cursor: pointer;
    transition: transform 0.18s ease, box-shadow 0.18s ease;
    background: none;
    border: none;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .img-btn:hover {
    transform: scale(1.10);                   /* ← effet grossissement des boutons */
  }

  .timer-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;                                 /* ← marge entre le timer et la box */
    flex: 1;                                  /* ← permet d'utiliser tout l'espace central et donc d'ajuster la longueur */
    justify-content: flex-end;                /* ← garde le timer à droite sur la même ligne que la barre */
  }

  /* BOX */
  .minutes-box {
    height: 25px;                             /* ← hauteur de la box */
    display: flex;
    align-items: center;
    background-color: #191919;                /* ← couleur du fond de la box */
    border: 1px solid #333333;                /* ← bordure de la box à ajouter si besoin */
    padding: 0 0px;                           /* ← marge entre la box et le timer */      
    flex-shrink: 0;
    border-radius: 4px;                       /* ← coins arrondis de la box */
  }
  
  .minutes-input {
    width: 38px;                              /* ← longueur de la box */
    font-size: 25px;                          /* ← taille des chiffres dans la box */
    font-family: '1st font', monospace;       /* ← police dans la box */
    text-align: center;
    border: none;
    outline: none;
    background: transparent;                                    /* ← couleur de fond de la box */
    color: #14DCFF;                                             /* ← couleur de la police dans la box */
    opacity: 1;                                                 /* ← opacité de la police dans la box */
    text-shadow: 0 0 2px rgba(20, 255, 251, 0.2);               /* ← effet néon sur le texte de la box */
    filter: drop-shadow(-2px 2px 0.3px rgba(102, 100, 87, 0));  /* ← effet ombre sur la police de la box */
    font-weight: 700;
  }
  
  .minutes-input::-webkit-outer-spin-button,
  .minutes-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  /* SYMBOL DANS LA BOX */
  .minutes-box span {
    color: #FFFFFF;                           /* ← couleur du symbol dans la box */
    font-weight: 400;
    margin-left: 1px;                         /* ← marge dans la box entre la valeur et le "m" */
    opacity: 0.15;
  }
  
  /* TIMER */
  .timer {
    color: #14DCFF;                                                          /* ← couleur de la police du timer */
    opacity: 1;                                                          /* ← opacité de la police du timer */
    font-weight: 200;
    font-size: 25px;                                                        /* ← taille de la police du timer */
    text-shadow: 0 0 10px rgba(20, 255, 251, 0.3);                          /* ← effet néon sur le timer */
    filter: drop-shadow(-0px 0px 0px rgba(102, 100, 87, 0));                /* ← effet ombre sur le timer (opacité sur la dernière valeur) */
  }
  
  /* COUCHE SECONDAIRE DU TIMER */
  .timer::before {
    content: "00:00:00";      /* affichage des zéros fixes */
    position: absolute;
    top: 0;
    left: 0;
    color: #14DCFF;           /* même couleur ou plus claire pour effet “LCD éteint” */
    opacity: 0.20;            /* opacité faible */
    pointer-events: none;     /* pour ne pas gêner l’interaction avec le timer */
    font-weight: 200;
    font-size: 25px;
    white-space: nowrap;      /* empêche le passage à la ligne */
    z-index: -1;              /* derrière le vrai timer */
  }
    
  .timer strong {
    font-weight: 700;                         /* ← gras sur les numéros du timer */
  }

  /* Symbol + Cagnotte */
  .score {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    width: 100%;
  }
  .flame {
    display: flex;
    align-items: center;
    font-size: 16px;                                                             /* ← taille du symbol (en ON et en OFF) */
    font-family: '2nd font', sans-serif;                                 /* ← police du symbol */
    font-weight: normal;                                                        /* ← Symbol en regular ou bold */
    color: var(--logo-off);
    text-shadow: none;
    position: relative;
    will-change: transform, color, text-shadow;
    transition: color 0.60s ease, text-shadow 0.60s ease;                       /* ← transition ON/OFF */
    margin-left: 3px;                                                           /* ← marge à gauche du symbol */
  }
  .flame.active {
    /* léger glow progressif (couleur contrôlée en :root) */
    color: #FF146E; 
    text-shadow: 0 0 6px rgba(255, 20, 110, 0.3);
    /* pulse CSS minimisé (n'affecte plus la taille globale) */
    animation: pulseFlame 1.8s ease-in-out infinite;
  }
  @keyframes pulseFlame {
    0%, 100% { transform: translateZ(0) scale3d(1,1,1); }
    50% { transform: translateZ(0) scale3d(1.080,1.080,1); }                    /* ← puissance du pulse effect, modifier la valeur scale3d */
  }

  .flame-count {
    display: none;                                                              /* ← valeur affichée seulement dans la cagnotte */
  }
  
  /* CAGNOTTE */
  .f-points {
    font-size: 22px;                                                            /* ← taille de la police de la cagnotte */
    font-weight: 700;
    color: #FFFFFF;
    white-space: nowrap;                                                        /* ← évite le wrapping */
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);                             /* ← effet néon sur la cagnotte */
  }
  
  .f-points span {
    font-weight: 400;
    opacity: 0.15;                            /* ← zéros plus discrets */
  }

  /* Animation +1 : plus fluide, start plus haut, easing agréable */
  .gain-popup {
   font-family: '3rd font', monospace;                                   /* ← police du +1 */
   font-weight: regular;
   position: absolute;
   left: 100%;
   top: 0;
   font-size: 22px;                                                             /* ← taille de la police du +1 */
   color: #FF146E;                                                              /* ← couleur de la police du +1 */
   font-weight: 500;
   transform-origin: left bottom;
   will-change: transform, opacity;
   animation: popFadeSmooth 2.2s linear forwards;
   pointer-events: none;
  }

@keyframes popFadeSmooth {
   0%   { opacity: 0;   transform: translateY(-10px) scale(0.80); }   /* fade in */
   20%  { opacity: 0.5; transform: translateY(-12px) scale(0.85); }   /* fade in */
   40%  { opacity: 1;   transform: translateY(-14px) scale(0.90); }  
   60%  { opacity: 0.8; transform: translateY(-16px) scale(0.90); }  
   80%  { opacity: 0.4; transform: translateY(-18px) scale(0.85); }  /* fade out */
   100% { opacity: 0;   transform: translateY(-20px) scale(0.80); }  /* fade out */
  }

  /* petit reset pour boutons et images */
  img.img-btn { display: block; }
  button.img-btn { color: inherit; background: transparent; border: none; }

</style>
</head>
<body>

<div class="container">

  <!-- Ligne 1 (progress bar) -->
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
    <div class="progress-text" id="progressText"><strong>0</strong>%</div>
  </div>

  <!-- Bloc Timer + Flamme -->
  <div class="timer-flame-block">
    <!-- Ligne 2 -->
    <div class="controls">
      <div class="btn-group">
        <img src="https://raw.githubusercontent.com/NationEight/XP-Science/main/PLAY.png" alt="Play" class="img-btn" id="playBtn">
        <img src="https://raw.githubusercontent.com/NationEight/XP-Science/main/STOP.png" alt="Stop" class="img-btn" id="stopBtn">
        <button id="bgBtn" class="img-btn" title="Mode clair/sombre">◑</button>  <!-- Bouton bascule clair/sombre (pas d'image pour l'instant) -->
      </div>

      <div class="timer-wrapper">
        <div class="minutes-box">
          <input type="number" class="minutes-input" id="minutesInput" min="1" value="50" maxlength="3"> <!-- blocage des 3 chiffres dans la box -->
          <span>⮩</span>
        </div>
        <div class="timer" id="timerDisplay">
          <strong>00</strong>:<strong>00</strong>:<strong>00</strong>
        </div>
      </div>
    </div>

    <!-- Ligne 3 -->
    <div class="score">
      <div class="flame" id="flameLogo">
        処理
        <div id="gainContainer" style="position:relative; margin-left:6px;"></div>
      </div>
      <div class="f-points" id="fPoints"></div>
    </div>
  </div>

</div>


<audio id="ringtone" src="https://raw.githubusercontent.com/NationEight/XP-Science/main/Sounds/NotionRingtone.mp3" preload="auto"></audio> 

<script>
  
  const GAIN_INTERVAL_SEC = 7;                                              // Intervalle de gain en secondes
  const MAX_POINTS = 9999999999999999;                                      // 16 chiffres max
  const LOCALSTORAGE_KEY = "pomodoro_cagnotte";                             // Clé stockage local

  // Variables temps / état
  let totalSeconds = 0;          
  let remainingSeconds = 0;      
  let isRunning = false;         
  let lastTimestamp = null;      
  let gainTimer = 0;             
  let fPoints = parseInt(localStorage.getItem(LOCALSTORAGE_KEY) || "0", 10);

  // Références DOM
  const timerDisplay = document.getElementById('timerDisplay');
  const minutesInput = document.getElementById('minutesInput');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const bgBtn = document.getElementById('bgBtn');
  const fPointsDisplay = document.getElementById('fPoints');
  const gainContainer = document.getElementById('gainContainer');
  const flameLogo = document.getElementById('flameLogo');
  const ringtone = document.getElementById('ringtone');

  // affichage initial de la cagnotte
  function formatPoints(value) {
    const str = String(value).padStart(16, "0");                              /* ← 18 chiffres affichés */
    const firstNonZero = str.search(/[^0]/);
    return str.split("").map((digit, i) =>
    i < firstNonZero ? `<span>${digit}</span>` : digit
    ).join("");
  }
  
  fPointsDisplay.innerHTML = formatPoints(fPoints);

  function addPoints(amount) {
    if (!amount) return;
    fPoints = Math.min(fPoints + amount, MAX_POINTS);
    localStorage.setItem(LOCALSTORAGE_KEY, fPoints);
    fPointsDisplay.innerHTML = formatPoints(fPoints);
  }

  function showGainAnimation() {
    const popup = document.createElement("div");
    popup.className = "gain-popup";
    popup.textContent = "+1";                                                   /* ← affichage du +1 */   
    gainContainer.appendChild(popup);
    setTimeout(() => popup.remove(), 2200);                                     /* ← durée de l'animation du +1 */ 
  }

  function updateTimerDisplay(sec) {
    sec = Math.max(0, Math.floor(sec));
    let hours = Math.floor(sec / 3600);
    let minutes = Math.floor((sec % 3600) / 60);
    let seconds = sec % 60;
    timerDisplay.innerHTML =
      `<strong>${String(hours).padStart(2,'0')}</strong>:` +
      `<strong>${String(minutes).padStart(2,'0')}</strong>:` +
      `<strong>${String(seconds).padStart(2,'0')}</strong>`;
  }

  function updateProgressBar(remaining) {
    let targetPercent = totalSeconds > 0 ? ((totalSeconds - remaining) / totalSeconds) * 100 : 0;
    targetPercent = Math.max(0, Math.min(100, targetPercent));
    progressFill.style.width = targetPercent + '%';
    progressText.innerHTML = `<strong>${Math.floor(targetPercent)}</strong>%`;
  }

  // reset / initialisation à la valeur de la box (appelé au chargement et sur STOP)
  function resetTimerToBoxValue() {
    const mins = parseInt(minutesInput.value, 10) || 0;
    totalSeconds = Math.max(0, mins * 60);
    remainingSeconds = totalSeconds;
    gainTimer = 0;
    lastTimestamp = null;
    updateTimerDisplay(remainingSeconds);
    updateProgressBar(remainingSeconds);
  }

  // TICK principal (ultra-stable) : utilise delta depuis lastTimestamp
  function tick(ts) {
    if (!isRunning) return;
    if (!lastTimestamp) lastTimestamp = ts;
    const delta = (ts - lastTimestamp) / 1000; // en secondes (float)
    lastTimestamp = ts;
    remainingSeconds -= delta;
    gainTimer += delta;
    if (gainTimer >= GAIN_INTERVAL_SEC) {
    const gains = Math.floor(gainTimer / GAIN_INTERVAL_SEC);
    gainTimer -= gains * GAIN_INTERVAL_SEC;
    addPoints(gains);
    for (let i = 0; i < gains; i++) showGainAnimation();
  }

    if (remainingSeconds <= 0) {
    remainingSeconds = 0;
    isRunning = false;
    lastTimestamp = null;
    flameLogo.classList.remove('active');
    playBtn.src = "PLAY.png";
    updateTimerDisplay(0);
    updateProgressBar(0);
    try { ringtone.currentTime = 0; ringtone.play().catch(()=>{}); } catch(e){}
    return;
  }

    updateTimerDisplay(remainingSeconds);
    updateProgressBar(remainingSeconds);
    requestAnimationFrame(tick);
  }

  minutesInput.addEventListener('input', () => {                  
    if (minutesInput.value.length > 3) {                      /* blocage de la box à 3 chiffres */    
    minutesInput.value = minutesInput.value.slice(0,3);         
  }                                                             
  
  if (!isRunning) {
    resetTimerToBoxValue();
  }
  });

  playBtn.addEventListener('click', () => {
    if (!isRunning) {
    if (remainingSeconds <= 0) resetTimerToBoxValue();
    if (remainingSeconds <= 0) return; 
    isRunning = true;
    lastTimestamp = null;
    playBtn.src = "PAUSE.png";
    flameLogo.classList.add('active');
    requestAnimationFrame(tick);
    } else {
    isRunning = false;
    playBtn.src = "PLAY.png";
    flameLogo.classList.remove('active');
    lastTimestamp = null;
  }
  });

  stopBtn.addEventListener('click', () => {
    isRunning = false;
    playBtn.src = "PLAY.png";
    flameLogo.classList.remove('active');
    resetTimerToBoxValue();
    progressFill.style.transition = 'none';       
    progressFill.style.width = '0%';
    progressText.innerHTML = `<strong>0</strong>%`;
    setTimeout(()=>{ progressFill.style.transition = 'width 0.12s linear'; }, 40);
    gainTimer = 0; 
  });

  bgBtn.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
  });

  resetTimerToBoxValue();
  fPointsDisplay.innerHTML = formatPoints(fPoints);

</script>

</body>
</html>
